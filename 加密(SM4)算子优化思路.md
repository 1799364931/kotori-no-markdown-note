# 加密(SM4)算子优化思路

## 1 硬件优化

### 1.1 硬件指令支持

通过ARM架构支持的sm4e指令，直接进行单次四次轮函数加密，在硬件设计上达到最优加密效率。

``[1]张笑从,郭华,张习勇,等.SM4算法快速软件实现[J].密码学报,2020,7(06):799-811.DOI:10.13868/j.cnki.jcr.000407.``

``[2]何诗洋,李晖,李凤华.SM4算法的FPGA优化实现方法[J].西安电子科技大学学报,2021,48(03):155-162.DOI:10.19665/j.issn1001-2400.2021.03.020.``

## 2 软件优化

算子 

### 2.1 sm4加密算法优化

通过对sm4加密算法进行优化，根据分组加密技术的特性，其加密优化类型可分为迭代型和流水型<sup>[1]</sup>，但由于分组密码存在并行(CTR/EBC)和串行(CBC/CFB/OFB)的加密模式，所以流水型的优化方式只适用于并行的加密模式，而迭代型优化方式可适用于所有加密模式。

#### 2.1.1 流水型算法优化

流水型的优化方式主要以并行执行多组加解密运算来提高效率，其主要运用SIMD技术<sup>[2]</sup>同时加载多组需加解密的数据，利用SIMD指令对多组数据进行计算。除多核并行带来的效率提升外，其在比特切片<sup>[3]</sup>，S盒查表优化等方面也带来效率提升。

#### 2.1.2 迭代型算法优化

迭代型的优化方式主要以对sm4算法本身的执行进行优化，根据sm4算法的特性，其优化主要在于轮函数处理，密钥编排，以及S盒查表优化<sup>[1]</sup>。可以通过轮函数合并(通过关键路径压缩，减少轮函数异或运算)，S盒查表方式优化(借用ARM架构已实现的AES相关加密指令，将AES的S盒与SM4的S盒进行映射，利用AES的S盒加速SM4的S盒查询)。

``[1]郝泽钰,代天傲,黄亦成,等.国密SM4算法CBC模式的高效设计与实现[J].计算机研究与发展,2024,61(06):1450-1457.``

``[2]郎欢,张蕾,吴文玲.SM4的快速软件实现技术[J].中国科学院大学学报,2018,35(02):180-187.``

``[3]王闯,丁滟,黄辰林,等.面向SIMD指令集的SM4算法比特切片优化[J].计算机研究与发展,2024,61(08):2097-2109.``

### 2.2 调度优化

#### 2.2.1 数据库缓存调度策略优化

根据不同算子的运算特性，选择对应的缓存策略<sup>[1]</sup>。

#### 2.2.2 透明代理加密架构优化

优化数据库的透明代理加密框架，对应用层与数据库的中间加密模块进行优化，对模块进行无关数据的旁路绕行、缓存优化、加密模块上下文的并行优化<sup>[1]</sup>。

#### 2.2.3 利用NUMA技术，为核心分配合适内存

NUMA技术在频繁发生跨die/chip访问时效率会下降，应当按照对应算子的特性，合理选择线程所绑定的NUMA节点<sup>[2]</sup>。

同时对内存进行合理分配，减少高延迟访存<sup>[3]</sup>。

``[1]刘力铭.MySQL数据库透明加密代理性能分析与优化[D].西安电子科技大学,2022.DOI:10.27389/d.cnki.gxadu.2022.000436.``

``[2]白硕.基于NUMA架构下的LSM-tree的读写优化技术研究[D].国防科技大学,2022.DOI:10.27052/d.cnki.gzjgu.2022.000253.``

``[3]曾丹.NUMA架构下多线程访存分析系统与实现[D].华中科技大学,2016.``

存储引擎 

密钥(random key随机生成的)的密文 被加密的数据

master key = 用户的key

